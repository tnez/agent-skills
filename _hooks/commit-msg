#!/usr/bin/env bash
#
# commit-msg hook
# 1. Validates commit message format (blank line between subject and body)
# 2. Strips AI/agent attribution from commit messages using Claude Code in non-interactive mode
#
# This hook ensures commit messages:
# - Have a blank line between subject (line 1) and body (line 3+) if body exists
# - Don't contain Claude Code signatures
# - Don't contain Co-Authored-By: Claude
# - Don't contain AI-generated emojis/attributions
#

set -e

COMMIT_MSG_FILE="$1"
ORIGINAL_MSG=$(cat "$COMMIT_MSG_FILE")

# Validate commit message format
# If there's more than one line, line 2 must be blank
LINE_COUNT=$(echo "$ORIGINAL_MSG" | wc -l | tr -d ' ')
if [ "$LINE_COUNT" -gt 1 ]; then
    SECOND_LINE=$(echo "$ORIGINAL_MSG" | sed -n '2p')
    if [ -n "$SECOND_LINE" ]; then
        echo "Error: Commit message format invalid"
        echo "The second line must be blank (separating subject from body)"
        echo ""
        echo "Current message:"
        echo "---"
        echo "$ORIGINAL_MSG"
        echo "---"
        echo ""
        echo "Expected format:"
        echo "  Line 1: Subject (summary)"
        echo "  Line 2: <blank line>"
        echo "  Line 3+: Body (detailed description)"
        exit 1
    fi
fi

# Create prompt for Claude Code to clean the commit message
PROMPT="Remove any AI or agent attribution from this git commit message. Specifically remove:
- Any 'Generated with Claude Code' or similar signatures
- Any 'Co-Authored-By: Claude' lines
- Any AI-related emojis (ðŸ¤–, etc.)
- Any other agentic attribution

Preserve the actual commit message content. Return ONLY the cleaned commit message, nothing else.

Commit message to clean:
---
$ORIGINAL_MSG
---"

# Use Claude Code in non-interactive mode to clean the message
CLEANED_MSG=$(echo "$PROMPT" | claude --non-interactive 2>/dev/null || echo "$ORIGINAL_MSG")

# If Claude Code isn't available or fails, fall back to simple sed-based cleaning
if [ -z "$CLEANED_MSG" ] || [ "$CLEANED_MSG" = "$ORIGINAL_MSG" ]; then
    CLEANED_MSG=$(echo "$ORIGINAL_MSG" | \
        sed '/ðŸ¤– Generated with \[Claude Code\]/d' | \
        sed '/Co-Authored-By: Claude/d' | \
        sed 's/ðŸ¤–//g' | \
        sed '/^[[:space:]]*$/d')
fi

# Write cleaned message back
echo "$CLEANED_MSG" > "$COMMIT_MSG_FILE"

exit 0
