#!/usr/bin/env bash
#
# commit-msg hook
# 1. Validates Conventional Commits format
# 2. Validates blank line between subject and body (if body exists)
# 3. Strips AI/agent attribution from commit messages using Claude Code in non-interactive mode
#
# This hook ensures commit messages:
# - Follow Conventional Commits format: type(scope): description
# - Have a blank line between subject (line 1) and body (line 3+) if body exists
# - Don't contain Claude Code signatures
# - Don't contain Co-Authored-By: Claude
# - Don't contain AI-generated emojis/attributions
#

set -e

COMMIT_MSG_FILE="$1"
ORIGINAL_MSG=$(cat "$COMMIT_MSG_FILE")
SUBJECT_LINE=$(echo "$ORIGINAL_MSG" | head -1)

# Validate Conventional Commits format
# Format: type(scope): description
# - type: feat, fix, docs, style, refactor, test, chore
# - scope: optional, can be skills/meta, skills/examples, ci, hooks, etc.
# - description: lowercase, no period at end

CONVENTIONAL_COMMIT_REGEX='^(feat|fix|docs|style|refactor|test|chore)(\([a-z0-9/_,-]+\))?: .+$'

if ! echo "$SUBJECT_LINE" | grep -qE "$CONVENTIONAL_COMMIT_REGEX"; then
    echo "Error: Commit message does not follow Conventional Commits format"
    echo ""
    echo "Current subject:"
    echo "  $SUBJECT_LINE"
    echo ""
    echo "Expected format:"
    echo "  type(scope): description"
    echo ""
    echo "Types:"
    echo "  feat:     New feature"
    echo "  fix:      Bug fix"
    echo "  docs:     Documentation only"
    echo "  style:    Code style (formatting, no logic change)"
    echo "  refactor: Code change (no feat/fix)"
    echo "  test:     Add/update tests"
    echo "  chore:    Maintenance (no src/test changes)"
    echo ""
    echo "Scopes (optional):"
    echo "  skills/meta      - Meta-skills (skill-creator, skill-tester, etc.)"
    echo "  skills/examples  - Example skills"
    echo "  ci               - CI/CD configuration"
    echo "  hooks            - Git hooks"
    echo ""
    echo "Examples:"
    echo "  feat(skills/meta): add install-skill meta-skill"
    echo "  fix(hooks): correct validation regex"
    echo "  chore: update dependencies"
    echo "  feat(skills/examples,skills/meta): add multiple skills"
    exit 1
fi

# Validate blank line between subject and body
# If there's more than one line, line 2 must be blank
LINE_COUNT=$(echo "$ORIGINAL_MSG" | wc -l | tr -d ' ')
if [ "$LINE_COUNT" -gt 1 ]; then
    SECOND_LINE=$(echo "$ORIGINAL_MSG" | sed -n '2p')
    if [ -n "$SECOND_LINE" ]; then
        echo "Error: Commit message format invalid"
        echo "The second line must be blank (separating subject from body)"
        echo ""
        echo "Current message:"
        echo "---"
        echo "$ORIGINAL_MSG"
        echo "---"
        echo ""
        echo "Expected format:"
        echo "  Line 1: type(scope): description"
        echo "  Line 2: <blank line>"
        echo "  Line 3+: Body (detailed description)"
        exit 1
    fi
fi

# Create prompt for Claude Code to clean the commit message
PROMPT="Remove any AI or agent attribution from this git commit message. Specifically remove:
- Any 'Generated with Claude Code' or similar signatures
- Any 'Co-Authored-By: Claude' lines
- Any AI-related emojis (ðŸ¤–, etc.)
- Any other agentic attribution

Preserve the actual commit message content. Return ONLY the cleaned commit message, nothing else.

Commit message to clean:
---
$ORIGINAL_MSG
---"

# Use Claude Code in non-interactive mode to clean the message
CLEANED_MSG=$(echo "$PROMPT" | claude --non-interactive 2>/dev/null || echo "$ORIGINAL_MSG")

# If Claude Code isn't available or fails, fall back to simple sed-based cleaning
if [ -z "$CLEANED_MSG" ] || [ "$CLEANED_MSG" = "$ORIGINAL_MSG" ]; then
    CLEANED_MSG=$(echo "$ORIGINAL_MSG" | \
        sed '/ðŸ¤– Generated with \[Claude Code\]/d' | \
        sed '/Co-Authored-By: Claude/d' | \
        sed 's/ðŸ¤–//g' | \
        sed '/^[[:space:]]*$/d')
fi

# Write cleaned message back
echo "$CLEANED_MSG" > "$COMMIT_MSG_FILE"

exit 0
